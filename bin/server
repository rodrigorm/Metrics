#!/usr/bin/env php
<?php

require_once __DIR__ . '/../vendor/autoload.php';
require_once __DIR__ . '/../library/data.php';

$db = db();
$loop = React\EventLoop\Factory::create();

$factory = new Datagram\Factory($loop);

$factory->createServer(2003)->then(function (Datagram\Socket $server) use ($db) {
    $server->on('message', function($message, $address, $server) use ($db) {
        list($target, $value, $timestamp) = explode(' ', trim($message));
        insert($db, $target, $value, $timestamp);
        echo 'client ', $address, ': ', trim($message), PHP_EOL;
    });
});

$loop->run();
