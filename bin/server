#!/usr/bin/env php
<?php

require_once __DIR__ . '/../vendor/autoload.php';
require_once __DIR__ . '/../library/data.php';
require_once __DIR__ . '/../library/api.php';

$loop = React\EventLoop\Factory::create();

$factory = new Datagram\Factory($loop);

$factory->createServer(2003)->then(function (Datagram\Socket $server) {
    global $count;
    $count = 0;
    $serverStart = microtime(true);

    $server->on('message', function($message, $address, $server) use ($serverStart) {
        $start = microtime(true);
        list($target, $value, $timestamp) = explode(' ', trim($message));
        insert(db(), $target, $value, $timestamp);
        metric_collect('metrics.server.elapsed', (microtime(true) - $start) * 1000);

        global $count;
        $count++;
        $elapsed = (microtime(true) - $serverStart);
        $velocity = $count / $elapsed;
        echo "\r", $count, ' / ', round($elapsed), 's = ', $velocity, ' messages/s';
    });
});

$loop->run();
